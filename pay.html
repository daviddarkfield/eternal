<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ETERNAL — Payment</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height: 1.45;
    }
    .wrap { max-width: 740px; margin: 0 auto; padding: 28px 18px 40px; }
    h1 { font-size: 30px; letter-spacing: 0.08em; margin: 0 0 18px; }
    .small { opacity: 0.85; font-size: 13px; }
    .card {
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      padding: 18px;
      margin-top: 18px;
      background: rgba(255,255,255,0.03);
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.08);
      color: #fff;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .hr { height: 1px; background: rgba(255,255,255,0.14); margin: 16px 0; }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      font-size: 12px;
      opacity: 0.9;
    }
    .pill.bad { border-color: rgba(255,70,70,0.45); }
    a { color: rgba(255,255,255,0.85); }
    #payment-element { margin-top: 14px; }
    #err { margin-top: 12px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ETERNAL</h1>
    <div class="small">DARKFIELD</div>

    <div class="card">
      <div class="small">Secure payment</div>
      <div style="margin-top:10px; font-size:22px;"><strong>US$1.99</strong></div>

      <div class="hr"></div>

      <div class="small">Enter your details</div>
      <form id="form">
        <div id="payment-element"></div>

        <div class="row" style="margin-top:14px;">
          <button class="btn" id="payBtn" type="submit">Pay</button>
          <a class="small" href="/">Cancel</a>
          <span class="pill" id="statePill">Preparing…</span>
        </div>

        <div class="small pill bad" id="err" style="display:none;"></div>
      </form>

      <p class="small" style="margin-top:14px; opacity:0.7;">
        You will be returned to ETERNAL automatically after payment.
      </p>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script>
    (async () => {
      const statePill = document.getElementById("statePill");
      const errBox = document.getElementById("err");
      const payBtn = document.getElementById("payBtn");
      const form = document.getElementById("form");

      function showErr(msg) {
        errBox.style.display = "";
        errBox.textContent = msg;
      }

      // 1) Get publishable key
      let pub;
      try {
        const cfgRes = await fetch("/api/config", { cache: "no-store" });
        const cfgText = await cfgRes.text();
        let cfg = {};
        try { cfg = JSON.parse(cfgText); } catch {}
        if (!cfgRes.ok) throw new Error(`config ${cfgRes.status}: ${cfgText.slice(0, 300)}`);
        pub = cfg.publishableKey;
        if (!pub) throw new Error(`config missing publishableKey: ${cfgText.slice(0, 300)}`);
      } catch (e) {
        console.error(e);
        showErr(String(e.message || e));
        statePill.textContent = "Error";
        return;
      }

      // 2) Create PaymentIntent on your server
      let clientSecret, pi;
      try {
        statePill.textContent = "Creating…";

        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 12000);

        const r = await fetch("/api/create-intent", {
          method: "POST",
          signal: ctrl.signal,
          cache: "no-store"
        });

        clearTimeout(t);

        const text = await r.text();
        let data = {};
        try { data = JSON.parse(text); } catch {}

        if (!r.ok) {
          throw new Error(`create-intent ${r.status}: ${text.slice(0, 300)}`);
        }

        clientSecret = data.clientSecret;
        pi = data.id;

        if (!clientSecret || !pi) {
          throw new Error(`Bad intent response: ${text.slice(0, 300)}`);
        }
      } catch (e) {
        console.error(e);
        showErr(String(e.message || e));
        statePill.textContent = "Error";
        return;
      }

      // 3) Mount Stripe Elements (dark / ritual) + SAFARI autofill/yellow readability fix
      // Safari may force a yellow autofill background inside the iframe that we can't fully remove.
      // So: keep dark styling generally, but force AUTOFILLED text to black for readability on yellow.
      const stripe = Stripe(pub);

      const appearance = {
        theme: "night",
        variables: {
          colorBackground: "#000000",
          colorText: "#ffffff",
          colorTextSecondary: "rgba(255,255,255,0.75)",
          colorDanger: "#ff4646",
          colorPrimary: "#cfcfcf",
          borderRadius: "14px",
          spacingUnit: "6px"
        },
        rules: {
          ".Input": {
            backgroundColor: "rgba(255,255,255,0.04)",
            border: "1px solid rgba(255,255,255,0.18)",
            color: "#ffffff",
            boxShadow: "none"
          },
          ".Input:focus": {
            backgroundColor: "rgba(255,255,255,0.10)",
            border: "1px solid rgba(255,255,255,0.35)",
            color: "#ffffff",
            boxShadow: "none",
            outline: "none"
          },
          ".Input--focus": {
            backgroundColor: "rgba(255,255,255,0.10)",
            border: "1px solid rgba(255,255,255,0.35)",
            color: "#ffffff",
            boxShadow: "none",
            outline: "none"
          },

          /* Safari/WebKit autofill: we can't reliably remove the yellow, so make text readable */
          ".Input--autofilled": {
            /* if Safari paints yellow, black text stays readable */
            color: "#000000",
            border: "1px solid rgba(255,255,255,0.35)",
            boxShadow: "none"
          },
          ".Input:-webkit-autofill": {
            color: "#000000",
            border: "1px solid rgba(255,255,255,0.35)",
            boxShadow: "none"
          },

          ".Input--invalid": {
            border: "1px solid rgba(255,70,70,0.55)"
          },
          ".Label": {
            color: "rgba(255,255,255,0.80)"
          },
          ".Error": {
            color: "#ff4646"
          }
        }
      };

      const elements = stripe.elements({ clientSecret, appearance });
      const paymentElement = elements.create("payment");
      paymentElement.mount("#payment-element");

      statePill.textContent = "Ready";

      // 4) Confirm payment (Stripe handles SCA if needed)
      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        errBox.style.display = "none";
        payBtn.disabled = true;
        statePill.textContent = "Processing…";

        const return_url = `${location.origin}/?pi=${encodeURIComponent(pi)}`;

        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: { return_url }
        });

        if (error) {
          console.error(error);
          showErr(error.message || "Payment failed. Please try again.");
          payBtn.disabled = false;
          statePill.textContent = "Ready";
          return;
        }
      });
    })();
  </script>
</body>
</html>
