<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ETERNAL — DARKFIELD</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height: 1.45;
    }
    .wrap { max-width: 740px; margin: 0 auto; padding: 28px 18px 40px; }
    h1 { font-size: 30px; letter-spacing: 0.08em; margin: 0 0 18px; }
    .small { opacity: 0.85; font-size: 13px; }
    .card {
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      padding: 18px;
      margin-top: 18px;
      background: rgba(255,255,255,0.03);
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.08);
      color: #fff;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .hr { height: 1px; background: rgba(255,255,255,0.14); margin: 16px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      font-size: 12px;
      opacity: 0.9;
    }
    .pill.ok { border-color: rgba(0,255,140,0.35); }
    .pill.bad { border-color: rgba(255,70,70,0.45); }

    /* Modal */
    .modalBack {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 22px;
    }
    .modal {
      max-width: 560px;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 16px;
      padding: 18px;
      background: #070707;
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
    }
    .modal h2 { margin: 0 0 10px; font-size: 18px; }
    .modal p { margin: 0 0 14px; opacity: 0.9; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ETERNAL</h1>
    <div class="small">DARKFIELD</div>

    <div class="card" id="publicCard">
      <p><strong>A SHOW FOR ONE PERSON ALONE IN THEIR BED.</strong><br/>
      It explores the temptation of eternal life and what price you would pay to achieve it.</p>

      <p class="small">“I want you to believe... to believe in things that you cannot.” — Bram Stoker</p>

      <div class="hr"></div>

      <p>
        You have been chosen and we thank you for your sacrifice.
        In return we offer you the opportunity for eternal life — but there are conditions.
      </p>

      <p class="small">
        ETERNAL is a 24 minute immersive audio experience for one person, alone in their bed.
        Commissioned by the 2020 Bram Stoker Festival, Dublin.
      </p>

      <div class="row" style="margin-top:14px;">
        <button class="btn" id="buyBtn">Listen now ($1.99)</button>
        <span class="pill" id="statePill">Locked</span>
      </div>

      <p class="small" id="publicHint" style="margin-top:10px;"></p>
    </div>

    <div class="card" id="paidCard" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div><strong>Unlocked</strong></div>
        <div class="pill ok" id="paidPill">Ready</div>
      </div>

      <div class="hr"></div>

      <p><strong>Before you begin</strong></p>
      <ul>
        <li>Listen with headphones.</li>
        <li>Get into bed. Alone.</li>
        <li>Lock the door. Silence your phone.</li>
        <li>This is scary.</li>
      </ul>

      <p class="small">
        When you press play, the audio will run to the end.
        If your device or browser interrupts playback, you can return and try again
        (until you complete it once, on this browser).
      </p>

      <div class="row" style="margin-top:14px;">
        <button class="btn" id="playBtn">Play</button>
        <span class="pill mono" id="sessionTag" style="display:none;"></span>
        <button class="btn" id="resetBtn" style="display:none;">Reset (testing)</button>
        <button class="btn" id="previewThanksBtn" style="display:none;">Preview thanks</button>
      </div>

      <div style="margin-top:14px; display:none;" id="playingBox">
        <div class="pill">Playing…</div>
        <div class="small" style="margin-top:8px;">Keep this tab open. Do not refresh.</div>
      </div>

      <div style="margin-top:14px; display:none;" id="doneBox">
        <div class="pill ok">Completed</div>
        <div class="small" style="margin-top:8px;">Redirecting…</div>
      </div>

      <audio id="player" preload="none" playsinline></audio>
    </div>
  </div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>Final warning</h2>
      <p>
        This experience will play through to the end.<br/>
        You cannot pause or restart it once it begins.
      </p>
      <div class="row">
        <button class="btn" id="confirmBtn">I understand. Begin.</button>
        <button class="btn" id="cancelBtn">Not yet</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---- local rules (simple & generous) ----
  // One completion per browser. If they close early, they can come back and try again.
  const LS_COMPLETED_AT = "eternal_completed_at_v1";

  // Price label (UI only). Make sure your Stripe create-checkout uses unit_amount=199.
  const PRICE_LABEL = "$1.99";

  const qs = new URLSearchParams(location.search);
  const sessionId = qs.get("session_id");
  const previewThanks = qs.get("preview") === "thanks";

  const publicCard = document.getElementById("publicCard");
  const paidCard = document.getElementById("paidCard");
  const buyBtn = document.getElementById("buyBtn");
  const playBtn = document.getElementById("playBtn");
  const resetBtn = document.getElementById("resetBtn");
  const previewThanksBtn = document.getElementById("previewThanksBtn");

  const statePill = document.getElementById("statePill");
  const paidPill = document.getElementById("paidPill");
  const sessionTag = document.getElementById("sessionTag");
  const publicHint = document.getElementById("publicHint");

  const modalBack = document.getElementById("modalBack");
  const confirmBtn = document.getElementById("confirmBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  const playingBox = document.getElementById("playingBox");
  const doneBox = document.getElementById("doneBox");

  const audio = document.getElementById("player");
  let wakeLock = null;

  // Set price text on the button
  buyBtn.textContent = `Listen now (${PRICE_LABEL})`;

  // Quick preview without listening:
  // /?preview=thanks will jump to thanks page (handy for testing)
  if (previewThanks) {
    location.replace("/thanks.html");
    return;
  }

  function isCompleted() {
    return Number(localStorage.getItem(LS_COMPLETED_AT) || "0") > 0;
  }

  function markCompletedLocal() {
    localStorage.setItem(LS_COMPLETED_AT, String(Date.now()));
  }

  // show reset + preview buttons only on pages.dev (optional)
  if (location.hostname.includes("pages.dev")) {
    resetBtn.style.display = "";
    previewThanksBtn.style.display = "";
    resetBtn.addEventListener("click", () => {
      if (!confirm("Reset completed state on this browser?")) return;
      localStorage.removeItem(LS_COMPLETED_AT);
      location.reload();
    });
    previewThanksBtn.addEventListener("click", () => {
      window.open("/thanks.html", "_blank");
    });
  }

  function showModal(onConfirm) {
    modalBack.style.display = "flex";
    confirmBtn.onclick = () => { modalBack.style.display = "none"; onConfirm(); };
    cancelBtn.onclick = () => { modalBack.style.display = "none"; };
  }

  async function api(path, opts) {
    const res = await fetch(path, opts);
    const text = await res.text().catch(()=> "");
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
    if (!res.ok) throw new Error(`API ${path} failed: ${res.status} ${text}`);
    return data;
  }

  async function refreshStatus() {
    if (!sessionId) return { ok: true, state: "locked" };
    return api(`/api/status?session_id=${encodeURIComponent(sessionId)}`, { method: "GET" });
  }

  function setUIFromState(apiState) {
    if (!sessionId) {
      statePill.textContent = "Locked";
      statePill.className = "pill";
      publicCard.style.display = "";
      paidCard.style.display = "none";
      publicHint.textContent = "";
      return;
    }

    sessionTag.style.display = "";
    sessionTag.textContent = `session: ${sessionId.slice(0, 10)}…`;

    if (isCompleted()) {
      statePill.textContent = "Completed";
      statePill.className = "pill ok";
      publicCard.style.display = "";
      paidCard.style.display = "none";
      publicHint.textContent = "This browser has completed the experience. Please purchase again to listen again.";
      return;
    }

    const state = String(apiState?.state || "").toLowerCase();

    if (state === "unlocked") {
      statePill.textContent = "Unlocked";
      statePill.className = "pill ok";
      publicCard.style.display = "none";
      paidCard.style.display = "";
      paidPill.textContent = "Ready";
      playBtn.disabled = false;
      doneBox.style.display = "none";
      playingBox.style.display = "none";
      return;
    }

    if (state === "locked") {
      statePill.textContent = "Locked";
      statePill.className = "pill bad";
      publicCard.style.display = "";
      paidCard.style.display = "none";
      publicHint.textContent = "Payment not verified yet. If you just paid, wait a moment and refresh.";
      return;
    }

    statePill.textContent = "Processing…";
    statePill.className = "pill";
    publicCard.style.display = "";
    paidCard.style.display = "none";
    publicHint.textContent = "Processing…";
  }

  buyBtn.addEventListener("click", async () => {
    buyBtn.disabled = true;
    try {
      const out = await api("/api/create-checkout", { method: "POST" });
      location.href = out.url;
    } catch (e) {
      alert("Payment setup failed. Please try again.");
      buyBtn.disabled = false;
      console.error(e);
    }
  });

  async function acquireWakeLock() {
    try {
      if ("wakeLock" in navigator) {
        wakeLock = await navigator.wakeLock.request("screen");
      }
    } catch (_) {}
  }

  function attachAntiPause() {
    audio.addEventListener("pause", () => {
      if (!audio.ended) audio.play().catch(()=>{});
    });

    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && !audio.ended) audio.play().catch(()=>{});
    });

    // block scrubbing best-effort
    let lastTime = 0;
    audio.addEventListener("timeupdate", () => {
      if (!audio.seeking) lastTime = audio.currentTime;
    });
    audio.addEventListener("seeking", () => {
      audio.currentTime = lastTime || 0;
    });
  }

  async function beginPlayback() {
    if (isCompleted()) return;

    if (!sessionId) {
      alert("Missing session_id. Please return to the link you received after payment.");
      playBtn.disabled = false;
      return;
    }

    playBtn.disabled = true;
    await acquireWakeLock();

    playingBox.style.display = "";
    doneBox.style.display = "none";

    // STREAM DIRECTLY (no fetch-to-blob).
    audio.src = `/api/audio?session_id=${encodeURIComponent(sessionId)}`;
    audio.controls = false;
    audio.loop = false;

    attachAntiPause();

    audio.addEventListener("ended", async () => {
      playingBox.style.display = "none";
      doneBox.style.display = "";
      try { if (wakeLock) await wakeLock.release(); } catch(_) {}

      markCompletedLocal();

      // Redirect to thanks page
      location.href = "/thanks.html";
    }, { once: true });

    await audio.play();
  }

  playBtn.addEventListener("click", () => {
    if (isCompleted()) return;
    showModal(() => beginPlayback().catch(e => {
      console.error(e);
      alert("Could not start playback. Please try again.");
      playBtn.disabled = false;
      playingBox.style.display = "none";
    }));
  });

  // Boot
  (async () => {
    if (!sessionId) {
      setUIFromState({ state: "locked" });
      return;
    }

    try {
      const s = await refreshStatus();
      setUIFromState(s);
    } catch (e) {
      console.error(e);
      setUIFromState({ state: "locked" });
      publicHint.textContent = "Could not verify payment right now. Please refresh.";
    }
  })();
})();
</script>
</body>
</html>

